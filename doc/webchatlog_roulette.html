<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Roulette - 룰렛</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="icon" href="data:image/x-icon;," type="image/x-icon">
  <!--link type="text/css" rel="stylesheet" href="main.56f98435-dark.css" /-->
  <style>
    .wheel-wrapper {
       float:left;
       width: 70%;
    }
    .gui-wrapper {
       background-color: white;
       float:right;
       width: 30%;
    }
    .gui-wrapper button {
        border: ridge;
    }
    #itemList {
        list-style-type: none;
        padding: 0;
    }
    #itemInput {
        display: inline;
        width: 80%;
    }
    .item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 5px 0;
    }
    .remove-btn {
        background-color: red;
        color: white;
        border: none;
        cursor: pointer;
        padding: 5px 10px;
    }
  </style>
  <script src = "./jquery/jquery-3.7.1.min.js"></script>
  <script src="spin-wheel-iife.js"></script>
  <script>
    let prop={items:[]};

    window.onload = () => {

      const container = document.querySelector('.wheel-wrapper');

      window.wheel = new spinWheel.Wheel(container);
      initwheel();
    }
        
    function spinwheel() {
      wheel.spin(Math.random(1)*360+360);
    }
    
    function stopwheel() {
      wheel.stop();
    }
    
    function randomHSLA(){
      return `hsla(${~~(360 * Math.random())}, 70%,  72%, 0.8)`
    }
    
    function initwheel() {
      wheel.stop();
      wheel.init(prop);
      wheel.rotationSpeedMax = 720;
      wheel.itemLabelFontSizeMax = 30;
      wheel.onRest= function (event) {
        console.log(event.currentIndex, prop.items[event.currentIndex].label);
      };
    }    
  </script>
</head>

<body>
  <div class="gui-wrapper">
    <button onclick="spinwheel()">돌리기</button>
    <button onclick="stopwheel()">중단</button>
    <button onclick="initwheel()" style="display: none">테스트</button>

    <h5>목록</h5>
    <input type="text" id="itemInput" onkeyup="enterKey(this)" placeholder="추가할 내용">
    <button id="addItemBtn">+</button>
    <ul id="itemList"></ul>
    
  </div>
  <div class="wheel-wrapper"></div>

<script type="text/javascript" src="reconnecting-websocket.min.js"></script>
<script type="text/javascript">

function enterKey() {
    if (window.event.keyCode == 13) {
        additembutton();
    }
}

function additembutton() {
    var itemInput = document.getElementById('itemInput');
    var itemText = itemInput.value.trim();
    if (itemText) {
        // find item
        var aitem=null;
        prop.items.forEach((ele) => {
            if(ele.label==itemText) {
              aitem=ele;
            }
        });
        if(aitem) {
            // add weight on existing item
            aitem.weight+=1;
            for(vi of document.getElementById('itemList').children) {
                if(vi.children[0].innerText==itemText) {
                    vi.children[1].innerText=aitem.weight; 
                }
            }
        } else {
            // add new item
            var li = document.createElement('li');
            li.className = 'item';
            li.innerHTML = '<span>'+itemText+'</span><span class="iweight">1</span><button class="remove-btn">-</button>';
            document.getElementById('itemList').appendChild(li);
            prop.items.push({label: itemText, labelColor: '#000000', backgroundColor: randomHSLA(), weight: 1});
            // add remove event
            li.querySelector('.remove-btn').addEventListener('click', function () {
                var txt=li.children[0].innerText;
                var item=null;
                prop.items.forEach((ele) => {
                   if(ele.label==txt) {
                     item=ele;
                   }
                });
                // delete item when weight==0
                if(item) {
                    var ix=prop.items.indexOf(item);
                    if(ix>-1) {
                        item.weight-=1;
                        if(item.weight<=0) {
                          prop.items.splice(ix,1);
                          li.remove();
                        } else {
                          li.children[1].innerText=item.weight;
                        }
                        initwheel();
                    }
                }
            });
        }
        itemInput.value = '';
        initwheel();
    }
}

document.getElementById('addItemBtn').addEventListener('click', function() {
    additembutton();
});

var itemmax=30;
var chatsock = new ReconnectingWebSocket("ws://localhost:65003","chat");
chatsock.reconnectInterval=2000;
chatsock.onmessage = function (event) {
    var div = $("#chatbox");
    chatline=$(event.data);
}
</script>
</body>

</html>